"use strict";var app=angular.module("myTodolistWebfrontApp",["ngRoute","ngCookies","ngResource","config"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{token:["tokenHandler","$q",function(a,b){var c=b.defer();return a.get()&&c.resolve(),c.promise}]}}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",resolve:{token:["tokenHandler","$q","$location",function(a,b,c){var d=b.defer();return a.get()?c.path("/"):d.resolve(),d.promise}]}}).otherwise({redirectTo:"/"})}]).config(["$httpProvider","$provide",function(a,b){b.factory("interceptor",["$rootScope","$q",function(a,b){return{responseError:function(c){return 401==c.status&&a.$broadcast("event:unauthorized"),b.reject(c)}}}]),a.interceptors.push("interceptor")}]).run(["$rootScope","$location",function(a,b){a.$on("event:unauthorized",function(){b.path("/login")})}]);app.controller("MainCtrl",["$scope","Todos","$timeout","tokenHandler","$location","backendErrorMessage",function(a,b,c,d,e,f){var g=function(){a.errors=f},h=function(b){a.todos.splice(a.todos.indexOf(b),1)};a.newTodo={title:"",completed:!1,priority:2},a.todos=b.query(),a.todos.$promise.catch(function(){c(function(){g()},0)}),a.predicate="created_at",a.setOrder=function(b){a.predicate=b},a.createTodo=function(){a.submittingNew=!0,b.save(a.newTodo,function(b){a.todos.push(b),a.newTodo.title=""},function(b){(a.errors=b.data)||g()}).$promise.finally(function(){a.submittingNew=!1})},a.$watch("newTodo",function(){a.errors=null},!0),a.$watch("editedTodo",function(){a.errors=null},!0),a.toggleCompleted=function(a){a.completed=!a.completed,a.submitting=!0,a.$patch().catch(function(b){404===b.status?h(a):(a.completed=!a.completed,g())}).finally(function(){a.submitting=!1})},a.editTodo=function(b){a.errors=null,angular.forEach(a.todos,function(a){a.editing=!1}),b.editing=!0,a.editedTodo=angular.copy(b)},a.updateTodo=function(b){b.submitting=!0,a.editedTodo.$patch().then(function(){b.title=a.editedTodo.title,b.due_date=a.editedTodo.due_date,b.priority=a.editedTodo.priority,b.editing=!1},function(c){404===c.status?h(b):(a.errors=c.data)||g()}).finally(function(){b.submitting=!1})},a.cancelEditing=function(b){a.errors=null,b.editing=!1},a.deleteTodo=function(a){a.submitting=!0,b.delete({id:a.id},function(){h(a)},function(b){a.submitting=!1,404===b.status?h(a):g()})},a.email=d.get().email,a.logout=function(){d.delete(),e.path("/login")}}]),app.controller("LoginCtrl",["$scope","$rootScope","$location","$http","backend","tokenHandler","backendErrorMessage",function(a,b,c,d,e,f,g){var h=function(){a.user.errors=g};a.submitting=!1,a.login=function(){a.submitting=!0,d.post(e+"/users/sign_in",{user:a.user}).success(function(d){d.success?(b.$broadcast("event:authenticated"),f.set(d.auth_token,d.user.email),c.path("/")):a.user.errors=d.info}).catch(h).finally(function(){a.submitting=!1})},a.signup=function(){a.submitting=!0,d.post(e+"/users",{user:a.user}).success(function(a){b.$broadcast("event:authenticated"),f.set(a.auth_token,a.user.email),c.path("/")}).error(function(b){(a.user.errors=b)||h()}).finally(function(){a.submitting=!1})}}]),app.factory("backend",["ENV",function(a){var b;return"production"===a?b="https://todolist-api.herokuapp.com":"development"===a&&(b="http://localhost:3000"),b}]),app.factory("Todos",["$resource","backend","tokenHandler",function(a,b,c){var d=a(b+"/todos/:id",{},{patch:{method:"PATCH",params:{id:"@id"}}});return c.wrapActions(d,["query","save","delete","patch"]),d}]),app.factory("tokenHandler",["$rootScope","$http","$q","$location","$cookies",function(a,b,c,d,e){var f=function(a,b){a["_"+b]=a[b],a[b]=function(c,d,e){return a["_"+b](angular.extend({},c||{},{user_token:g.get().token,user_email:g.get().email}),d,e)}},g={set:function(a,b){e.token=a,e.email=b},get:function(){return e.token?{token:e.token,email:e.email}:(a.$broadcast("event:unauthorized"),null)},"delete":function(){delete e.token,delete e.email},wrapActions:function(a,b){for(var c=a,d=0;d<b.length;d++)f(c,b[d]);return c}};return g}]),app.value("backendErrorMessage","There seems to be a problem with the backend."),app.directive("errors",function(){return{restrict:"E",scope:{value:"@"},template:"<div class='alert alert-danger' ng-show='value'>{{value}}</div>"}});